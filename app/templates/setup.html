{% extends "base.html" %}
{% block title %}Setup - Tootkeeper{% endblock %}

{% block content %}
<div class="setup-page">
    <div class="setup-card">
        <h1>Welcome to Tootkeeper</h1>
        <p class="setup-desc">Archive your Mastodon activity with full-text search. Connect your account to get started.</p>

        {% if settings.get('account_acct') %}
        <div class="current-account">
            <h2>Connected Account</h2>
            <div class="account-info">
                {% if settings.get('account_avatar') %}
                <img src="{{ settings.account_avatar }}" alt="" class="avatar-large">
                {% endif %}
                <div>
                    <strong>{{ settings.get('account_display_name', '') }}</strong>
                    <div class="acct">@{{ settings.account_acct }}@{{ settings.get('instance_url', '').replace('https://', '').replace('http://', '') }}</div>
                </div>
            </div>
            <a href="/auth/logout" class="btn btn-danger" onclick="return confirm('Disconnect your account? Your archived data will be kept.')">Disconnect</a>
            <a href="/" class="btn btn-sync">Go to Dashboard</a>
        </div>
        {% else %}
        {% if error %}
        <div class="error-msg">{{ error }}</div>
        {% endif %}

        <form action="/auth/login" method="post" class="setup-form">
            <label for="instance_url">Your Mastodon Instance</label>
            <div class="input-row">
                <input
                    type="text"
                    id="instance_url"
                    name="instance_url"
                    placeholder="mastodon.social"
                    value="{{ settings.get('instance_url', '').replace('https://', '') }}"
                    required
                    autofocus
                >
                <button type="submit" class="btn btn-sync">Login with Mastodon</button>
            </div>
            <p class="setup-hint">Enter your instance domain (e.g. mastodon.social, fosstodon.org). You'll be redirected to authorize read-only access.</p>
        </form>
        {% endif %}

        <div class="setup-features">
            <h3>What gets archived</h3>
            <ul>
                <li>Your toots (posts, replies, boosts)</li>
                <li>Notifications (who liked, boosted, replied to your toots)</li>
                <li>Your favorites (toots you liked)</li>
                <li>Your bookmarks</li>
            </ul>
            <p class="setup-hint">Only <strong>read</strong> permission is requested. This app will never post, like, or modify anything on your behalf.</p>
        </div>

        <div class="ai-settings">
            <h3>AI Roast (Optional)</h3>
            <p class="setup-hint" style="margin-bottom: 1rem;">Connect an AI provider to get a personalized roast on your dashboard based on your posting habits.</p>

            {% if ai_saved %}
            <div class="sync-status done" style="display:block; margin-bottom: 1rem;">AI settings saved!</div>
            {% endif %}

            <form action="/settings/ai" method="post" class="setup-form">
                <label for="ai_provider">Provider</label>
                <select id="ai_provider" name="ai_provider" class="select-input" onchange="toggleAiFields()">
                    <option value="">Disabled</option>
                    <option value="anthropic" {{ 'selected' if settings.get('ai_provider') == 'anthropic' }}>Anthropic (Claude)</option>
                    <option value="openai" {{ 'selected' if settings.get('ai_provider') == 'openai' }}>OpenAI (GPT)</option>
                    <option value="gemini" {{ 'selected' if settings.get('ai_provider') == 'gemini' }}>Google (Gemini)</option>
                    <option value="openai-compatible" {{ 'selected' if settings.get('ai_provider') == 'openai-compatible' }}>OpenAI-Compatible (Ollama, etc.)</option>
                </select>

                <div id="ai-fields" style="{{ '' if settings.get('ai_provider') else 'display:none;' }}">
                    <label for="ai_api_key" style="margin-top: 0.75rem;">API Key</label>
                    <input type="password" id="ai_api_key" name="ai_api_key" placeholder="sk-..." value="{{ settings.get('ai_api_key', '') }}">

                    <label for="ai_model" style="margin-top: 0.75rem;">Model <span class="setup-hint">(optional, uses sensible default)</span></label>
                    <input type="text" id="ai_model" name="ai_model" placeholder="e.g. claude-sonnet-4-5-20250929, gpt-4o, gemini-2.0-flash" value="{{ settings.get('ai_model', '') }}">

                    <div id="ai-base-url-row" style="{{ '' if settings.get('ai_provider') == 'openai-compatible' else 'display:none;' }}">
                        <label for="ai_base_url" style="margin-top: 0.75rem;">Base URL</label>
                        <input type="text" id="ai_base_url" name="ai_base_url" placeholder="http://localhost:11434/v1" value="{{ settings.get('ai_base_url', '') }}">
                    </div>
                </div>

                <button type="submit" class="btn btn-sync" style="margin-top: 1rem;">Save AI Settings</button>
            </form>
        </div>
    </div>
</div>

<script>
function toggleAiFields() {
    var provider = document.getElementById('ai_provider').value;
    document.getElementById('ai-fields').style.display = provider ? '' : 'none';
    document.getElementById('ai-base-url-row').style.display = provider === 'openai-compatible' ? '' : 'none';
}
</script>
{% endblock %}
